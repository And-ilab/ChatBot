{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="csrf-token" content="{{ csrf_token }}">
    <title>{% block title %} {% endblock %}</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css">
    <link rel="stylesheet" href="{% static 'dashboard/css/dashboard.css' %}">
    <style>
        .chat-user {
            font-size: 0.9rem;
        }
        .chat-time {
            font-size: 0.8rem;
        }

        .message-time {
            font-size: 0.8rem;
        }

        .message-sender {
            font-size: 1rem;
            font-weight: bold;
        }

        .message-content {
            font-size: 0.9rem;
        }

    </style>
</head>
<body>
    <div class="d-flex">
        <div class="sidebar">
            <ul class="nav flex-column">
                <li class="nav-item">
                    <a href="#" class="nav-link active" onclick="setActive(this)">
                        <i class="fa fa-archive"></i>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" onclick="setActive(this)">
                        <i class="fa fa-chart-line"></i>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="{% url 'chat_dashboard:user_list' %}" class="nav-link" onclick="setActive(this)">
                        <i class="fa fa-users"></i>
                    </a>
                </li>
            </ul>
            <div class="account-wrapper">
                {% if user.is_authenticated %}
                    <a href="{% url 'authentication:logout' %}" class="nav-link">Логаут</a>
                {% else %}
                    <a href="{% url 'authentication:login' %}" class="nav-link">Логин</a>
                {% endif %}
            </div>

        </div>
        <div class="container-fluid p-0 vh-100">
            {% block content %}
            {% endblock %}
        </div>
    </div>

    <script>
        function loadMessages(dialogId) {
            const allDialogs = document.querySelectorAll('.chat-item');
            allDialogs.forEach(dialog => {
                dialog.style.backgroundColor = 'transparent';
            });

            const selectedDialog = document.getElementById('dialog-' + dialogId);
            selectedDialog.style.backgroundColor = '#e0e0e0';

            fetch(`/api/messages/${dialogId}/`)
                .then(response => response.json())
                .then(data => {
                    const chatMessagesContainer = document.getElementById('chat-messages');
                    chatMessagesContainer.innerHTML = '';

                    data.messages.forEach(message => {
                        const messageElement = document.createElement('div');
                        messageElement.classList.add('d-flex', 'justify-content-start', 'message-item', 'w-90', 'mb-3');
                        messageElement.innerHTML = `
                            <div class="message-wrapper"
                                 style="background-color: #f1f1f1; border-radius: 10px; padding: 5px 10px 20px 10px; position: relative; min-width: 180px; max-width: 70%; overflow-x: wrap;">
                                <div class="d-flex message-sender">${message.sender}</div>
                                <div class="d-flex message-content">${message.content}</div>
                                <div class="d-flex message-time text-muted" style="position: absolute; right: 10px; bottom: 2px;">
                                    ${message.timestamp}
                                </div>
                            </div>
                        `;
                        chatMessagesContainer.appendChild(messageElement);
                    });
                });
        }

        document.addEventListener('DOMContentLoaded', function () {
            const sendButton = document.getElementById('send-message-button');

            if (sendButton) {
                sendButton.addEventListener('click', function () {
                    const input = document.querySelector('.form-control');
                    const messageContent = input.value.trim();

                    if (messageContent !== '') {
                        const activeDialog = document.querySelector('.chat-item.active');
                        const dialogId = activeDialog ? activeDialog.id.split('-')[1] : null;

                        if (dialogId) {
                            fetch(`/api/send-message/${dialogId}/`, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'X-CSRFToken': getCSRFToken()
                                },
                                body: JSON.stringify({
                                    sender_type: 'bot',
                                    content: messageContent
                                })
                            })
                            .then(response => response.json())
                            .then(data => {
                                input.value = '';
                                loadMessages(dialogId);
                            })
                            .catch(error => {
                                console.error('Ошибка при отправке сообщения:', error);
                            });
                        }
                    }
                });
            }
        });

        function getCSRFToken() {
            const csrfTokenMeta = document.querySelector("meta[name='csrf-token']");
            return csrfTokenMeta ? csrfTokenMeta.getAttribute("content") : "";
        }

        function setActiveDialog(dialogElement) {
            const dialogs = document.querySelectorAll('.chat-item');
            dialogs.forEach(dialog => dialog.classList.remove('active'));
            dialogElement.classList.add('active');
        }

        function updateUserInfo(username) {
            const userInfoElement = document.querySelector('.user-info h4');
            if (userInfoElement) {
                userInfoElement.textContent = username;
            }
        }

    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>